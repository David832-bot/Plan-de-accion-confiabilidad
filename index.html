<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Progreso por Objetivo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="container mx-auto p-6 space-y-8">

  <h1 class="text-3xl font-bold text-center">Progreso del Plan de Acci√≥n</h1>
  <p class="text-center text-gray-600 mb-6">Divisi√≥n de Ingenier√≠a y Confiabilidad</p>

  <!-- CONTADORES Y LOGIN -->
  <div class="flex justify-between items-center mb-4">
    <div class="grid grid-cols-3 gap-4 text-center">
      <div class="bg-yellow-100 p-4 rounded shadow">
        <p class="text-yellow-700 font-semibold">Pendientes</p>
        <p id="pending-count" class="text-3xl font-bold text-yellow-500">0</p>
      </div>
      <div class="bg-blue-100 p-4 rounded shadow">
        <p class="text-blue-700 font-semibold">En Progreso</p>
        <p id="progress-count" class="text-3xl font-bold text-blue-500">0</p>
      </div>
      <div class="bg-green-100 p-4 rounded shadow">
        <p class="text-green-700 font-semibold">Completadas</p>
        <p id="completed-count" class="text-3xl font-bold text-green-500">0</p>
      </div>
    </div>

    <button id="btnLogin" class="bg-gray-800 text-white px-4 py-2 rounded">üîê Iniciar sesi√≥n</button>
  </div>

  <!-- üéØ RESUMEN DE OBJETIVOS -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-bold mb-3 text-center">üéØ Avance por Objetivo</h2>
    <ul id="objective-list" class="space-y-2"></ul>
  </div>

  <!-- GRAFICO GENERAL -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="font-bold mb-2 text-center">Estado General</h2>
    <canvas id="objectiveChart"></canvas>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbziwTWsFqJC7S-5_wh1V-5dD8Q-jFDR2oVAMBhL1MS6Z_J0zZRIlkestl2sTQSFEO70/exec";
const PASSWORD = "DIMAV2024";

const OBJECTIVE_NAMES = {
  1: "Informes de Confiabilidad",
  2: "Power BI",
  3: "Capacitaci√≥n (actualizada con SAP)",
  4: "Avi√≥nica"
};

let tasksData = [];
let canEdit = false;

async function loadTasks() {
  const res = await fetch(API_URL);
  tasksData = await res.json();
}

function updateCounters() {
  const c = {'Pendiente':0,'En Progreso':0,'Completado':0};
  tasksData.forEach(t=>c[t.status]++);
  document.getElementById('pending-count').textContent = c['Pendiente'];
  document.getElementById('progress-count').textContent = c['En Progreso'];
  document.getElementById('completed-count').textContent = c['Completado'];
}

let objectiveChart;

function renderObjectiveSummary() {
  const container = document.getElementById('objective-list');
  container.innerHTML = '';

  const objetivos = [...new Set(tasksData.map(t => t.objectiveId))];

  objetivos.forEach(obj => {
    const actividades = tasksData.filter(t => t.objectiveId === obj);
    const total = actividades.length;
    const completadas = actividades.filter(t => t.status === 'Completado').length;
    const porcentaje = Math.round((completadas / total) * 100);

    container.innerHTML += `
      <li class="border rounded p-3 flex items-center gap-4">
        <div class="w-1/3 font-bold">Objetivo ${obj}: ${OBJECTIVE_NAMES[obj]}</div>
        <div class="flex-1 bg-gray-200 rounded-full h-4">
          <div class="bg-green-400 h-4 rounded-full" style="width:${porcentaje}%;"></div>
        </div>
        <div class="text-sm text-gray-600 w-28 text-center">
          ${completadas}/${total} completadas
        </div>
        <div class="font-bold text-green-700 w-12 text-center">${porcentaje}%</div>
      </li>
    `;
  });
}

function renderObjectiveChart() {
  const octx = document.getElementById('objectiveChart');
  const objetivos = [...new Set(tasksData.map(t=>t.objectiveId))];
  const porcentajes = objetivos.map(obj => {
    const total = tasksData.filter(t => t.objectiveId === obj).length;
    const comp = tasksData.filter(t => t.objectiveId === obj && t.status === 'Completado').length;
    return Math.round((comp / total) * 100);
  });

  if (objectiveChart) objectiveChart.destroy();
  objectiveChart = new Chart(octx, {
    type:'bar',
    data:{
      labels:objetivos.map(o=>`Obj ${o}: ${OBJECTIVE_NAMES[o]}`),
      datasets:[{
        label:'% Completado',
        data:porcentajes,
        backgroundColor:'#86EFAC'
      }]
    },
    options:{
      responsive:true,
      scales:{y:{beginAtZero:true, max:100}},
      plugins:{tooltip:{callbacks:{label:ctx=>ctx.parsed.y + '%'}}}
    }
  });
}

function updateUI(){
  updateCounters();
  renderObjectiveSummary();
  renderObjectiveChart();
}

document.addEventListener('DOMContentLoaded', async ()=>{
  document.getElementById('btnLogin').addEventListener('click', ()=>{
    const clave = prompt("Ingrese la contrase√±a para habilitar edici√≥n:");
    if(clave === PASSWORD){
      canEdit = true;
      alert("‚úÖ Edici√≥n habilitada");
    } else {
      alert("‚ùå Contrase√±a incorrecta");
    }
  });

  await loadTasks();
  updateUI();
});
</script>

</body>
</html>
