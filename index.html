<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plan de Acci√≥n Interactivo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="container mx-auto p-6 space-y-8">

  <h1 class="text-3xl font-bold text-center">Plan de Acci√≥n Interactivo</h1>
  <p class="text-center text-gray-600 mb-6">Divisi√≥n de Ingenier√≠a y Confiabilidad</p>

  <!-- CONTADORES Y BOT√ìN LOGIN -->
  <div class="flex justify-between items-center mb-4">
    <div class="grid grid-cols-3 gap-4 text-center">
      <div class="bg-yellow-100 p-4 rounded shadow">
        <p class="text-yellow-700 font-semibold">Pendientes</p>
        <p id="pending-count" class="text-3xl font-bold text-yellow-500">0</p>
      </div>
      <div class="bg-blue-100 p-4 rounded shadow">
        <p class="text-blue-700 font-semibold">En Progreso</p>
        <p id="progress-count" class="text-3xl font-bold text-blue-500">0</p>
      </div>
      <div class="bg-green-100 p-4 rounded shadow">
        <p class="text-green-700 font-semibold">Completadas</p>
        <p id="completed-count" class="text-3xl font-bold text-green-500">0</p>
      </div>
    </div>

    <button id="btnLogin" class="bg-gray-800 text-white px-4 py-2 rounded">üîê Iniciar sesi√≥n</button>
  </div>

  <!-- üìã AVANCE POR OBJETIVO -->
  <div class="bg-white p-4 rounded shadow mt-6">
    <h2 class="text-xl font-bold mb-3 text-center">üéØ Avance por Objetivo</h2>
    <ul id="objective-list" class="space-y-2"></ul>
  </div>

  <!-- FILTROS -->
  <div class="flex justify-center gap-4 mt-6">
    <button data-filter="Todos" class="filter-btn bg-blue-600 text-white px-4 py-2 rounded">Todos</button>
    <button data-filter="Pendiente" class="filter-btn bg-gray-200 px-4 py-2 rounded">Pendientes</button>
    <button data-filter="En Progreso" class="filter-btn bg-gray-200 px-4 py-2 rounded">En Progreso</button>
    <button data-filter="Completado" class="filter-btn bg-gray-200 px-4 py-2 rounded">Completadas</button>
  </div>

  <!-- TABLA DE ACTIVIDADES -->
  <table class="min-w-full bg-white border mt-4">
    <thead class="bg-gray-100">
      <tr>
        <th class="py-2 px-4">ID</th>
        <th class="py-2 px-4">Objetivo</th>
        <th class="py-2 px-4">Actividad</th>
        <th class="py-2 px-4">Responsable</th>
        <th class="py-2 px-4">Plazo</th>
        <th class="py-2 px-4">Estado</th>
      </tr>
    </thead>
    <tbody id="task-table-body"></tbody>
  </table>

  <!-- GRAFICOS -->
  <div class="grid grid-cols-2 gap-8">
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-bold mb-2 text-center">Estado General</h2>
      <canvas id="statusChart"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <h2 class="font-bold mb-2 text-center">Avance por Semana</h2>
      <canvas id="ganttChart"></canvas>
    </div>
  </div>

  <!-- GRAFICO DE OBJETIVOS -->
  <div class="bg-white p-4 rounded shadow col-span-2">
    <h2 class="font-bold mb-2 text-center">Avance % por Objetivo</h2>
    <canvas id="objectiveChart"></canvas>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbziwTWsFqJC7S-5_wh1V-5dD8Q-jFDR2oVAMBhL1MS6Z_J0zZRIlkestl2sTQSFEO70/exec";
const PASSWORD = "DIMAV2024";

const OBJECTIVE_NAMES = {
  1: "Informes de Confiabilidad",
  2: "Power BI",
  3: "Capacitaci√≥n (actualizada con SAP)",
  4: "Avi√≥nica"
};

let tasksData = [];
let currentFilter = "Todos";
let canEdit = false;

async function loadTasks() {
  const res = await fetch(API_URL);
  tasksData = await res.json();
}

async function saveTask(id, newStatus) {
  await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({id, status:newStatus})
  });
}

function getFilteredTasks() {
  if (currentFilter === "Todos") return tasksData;
  return tasksData.filter(t => t.status === currentFilter);
}

function renderTable() {
  const tbody = document.getElementById('task-table-body');
  tbody.innerHTML = '';
  getFilteredTasks().forEach(t => {
    tbody.innerHTML += `
      <tr class="border-b">
        <td class="py-2 px-4">${t.id}</td>
        <td class="py-2 px-4">Objetivo ${t.objectiveId}: ${OBJECTIVE_NAMES[t.objectiveId]}</td>
        <td class="py-2 px-4">${t.description}</td>
        <td class="py-2 px-4">${t.responsible}</td>
        <td class="py-2 px-4">${t.deadline}</td>
        <td class="py-2 px-4">
          <select data-id="${t.id}" class="border rounded p-1" ${!canEdit?'disabled':''}>
            <option ${t.status==='Pendiente'?'selected':''}>Pendiente</option>
            <option ${t.status==='En Progreso'?'selected':''}>En Progreso</option>
            <option ${t.status==='Completado'?'selected':''}>Completado</option>
          </select>
        </td>
      </tr>`;
  });

  document.querySelectorAll('select[data-id]').forEach(sel=>{
    sel.addEventListener('change', async e=>{
      const id = e.target.dataset.id;
      const task = tasksData.find(x=>x.id == id);
      task.status = e.target.value;
      await saveTask(id, task.status);
      updateUI();
    });
  });
}

function updateCounters() {
  const c = {'Pendiente':0,'En Progreso':0,'Completado':0};
  tasksData.forEach(t=>c[t.status]++);
  document.getElementById('pending-count').textContent = c['Pendiente'];
  document.getElementById('progress-count').textContent = c['En Progreso'];
  document.getElementById('completed-count').textContent = c['Completado'];
}

let statusChart, ganttChart, objectiveChart;

function updateCharts() {
  const ctx = document.getElementById('statusChart');
  const counts = {'Pendiente':0,'En Progreso':0,'Completado':0};
  tasksData.forEach(t=>counts[t.status]++);

  if (statusChart) statusChart.destroy();
  statusChart = new Chart(ctx, {
    type:'bar',
    data:{
      labels:['Pendiente','En Progreso','Completado'],
      datasets:[{
        label:'Tareas',
        data:[counts['Pendiente'],counts['En Progreso'],counts['Completado']],
        backgroundColor:['#FDE68A','#93C5FD','#A7F3D0']
      }]
    },
    options:{responsive:true,plugins:{legend:{display:false}}}
  });

  const gctx = document.getElementById('ganttChart');
  const semanas = [...new Set(tasksData.map(t=>t.deadline))];
  const datos = semanas.map(s=>tasksData.filter(t=>t.deadline===s).length);

  if (ganttChart) ganttChart.destroy();
  ganttChart = new Chart(gctx, {
    type:'line',
    data:{
      labels:semanas,
      datasets:[{
        label:'Tareas por semana',
        data:datos,
        fill:true,
        backgroundColor:'#BFDBFE',
        borderColor:'#3B82F6'
      }]
    },
    options:{responsive:true}
  });

  const octx = document.getElementById('objectiveChart');
  const objetivos = [...new Set(tasksData.map(t=>t.objectiveId))];
  const porcentajes = objetivos.map(obj => {
    const total = tasksData.filter(t => t.objectiveId === obj).length;
    const comp = tasksData.filter(t => t.objectiveId === obj && t.status === 'Completado').length;
    return Math.round((comp / total) * 100);
  });

  if (objectiveChart) objectiveChart.destroy();
  objectiveChart = new Chart(octx, {
    type:'bar',
    data:{
      labels:objetivos.map(o=>`Obj ${o}: ${OBJECTIVE_NAMES[o]}`),
      datasets:[{
        label:'% Completado',
        data:porcentajes,
        backgroundColor:'#86EFAC'
      }]
    },
    options:{
      responsive:true,
      scales:{y:{beginAtZero:true, max:100}},
      plugins:{tooltip:{callbacks:{label:ctx=>ctx.parsed.y + '%'}}}
    }
  });
}

function renderObjectiveList() {
  const container = document.getElementById('objective-list');
  container.innerHTML = '';

  const objetivos = [...new Set(tasksData.map(t => t.objectiveId))];

  objetivos.forEach(obj => {
    const actividades = tasksData.filter(t => t.objectiveId === obj);
    const total = actividades.length;
    const completadas = actividades.filter(t => t.status === 'Completado').length;
    const porcentaje = Math.round((completadas / total) * 100);

    container.innerHTML += `
      <li class="border rounded p-2 flex items-center gap-4">
        <span class="font-bold text-center">Objetivo ${obj}: ${OBJECTIVE_NAMES[obj]}</span>
        <div class="flex-1 bg-gray-200 rounded-full h-3">
          <div class="bg-green-400 h-3 rounded-full" style="width:${porcentaje}%;"></div>
        </div>
        <span class="text-sm text-gray-600">${completadas}/${total} actividades</span>
        <span class="font-bold text-green-700">${porcentaje}%</span>
      </li>
    `;
  });
}

function updateUI(){
  renderTable();
  updateCounters();
  updateCharts();
  renderObjectiveList();
}

document.addEventListener('DOMContentLoaded', async ()=>{
  document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      currentFilter = e.target.dataset.filter;
      document.querySelectorAll('.filter-btn').forEach(b=>{
        b.classList.remove('bg-blue-600','text-white');
        b.classList.add('bg-gray-200','text-gray-800');
      });
      e.target.classList.remove('bg-gray-200','text-gray-800');
      e.target.classList.add('bg-blue-600','text-white');
      updateUI();
    });
  });

  document.getElementById('btnLogin').addEventListener('click', ()=>{
    const clave = prompt("Ingrese la contrase√±a para habilitar edici√≥n:");
    if(clave === PASSWORD){
      canEdit = true;
      alert("‚úÖ Edici√≥n habilitada");
      updateUI();
    } else {
      alert("‚ùå Contrase√±a incorrecta");
    }
  });

  await loadTasks();
  updateUI();
});
</script>

</body>
</html>
