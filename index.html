<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Plan de Acci√≥n Interactivo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="container mx-auto p-6 space-y-8">

  <h1 class="text-3xl font-bold text-center">Plan de Acci√≥n Interactivo</h1>
  <p class="text-center text-gray-600 mb-6">Divisi√≥n de Ingenier√≠a y Confiabilidad</p>

  <!-- CONTADORES Y BOT√ìN LOGIN -->
  <div class="flex justify-between items-center mb-4">
    <div class="grid grid-cols-3 gap-4 text-center">
      <div class="bg-yellow-100 p-4 rounded shadow">
        <p class="text-yellow-700 font-semibold">Pendientes</p>
        <p id="pending-count" class="text-3xl font-bold text-yellow-500">0</p>
      </div>
      <div class="bg-blue-100 p-4 rounded shadow">
        <p class="text-blue-700 font-semibold">En Progreso</p>
        <p id="progress-count" class="text-3xl font-bold text-blue-500">0</p>
      </div>
      <div class="bg-green-100 p-4 rounded shadow">
        <p class="text-green-700 font-semibold">Completadas</p>
        <p id="completed-count" class="text-3xl font-bold text-green-500">0</p>
      </div>
    </div>

    <button id="btnLogin" class="bg-gray-800 text-white px-4 py-2 rounded">üîê Iniciar sesi√≥n</button>
  </div>

  <!-- üìã RESUMEN DE OBJETIVOS -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-bold mb-3 text-center">üéØ Avance por Objetivo</h2>
    <ul id="objective-summary" class="space-y-2"></ul>
  </div>

  <!-- FILTROS -->
  <div class="flex justify-center gap-4 mt-6">
    <button data-filter="Todos" class="filter-btn bg-blue-600 text-white px-4 py-2 rounded">Todos</button>
    <button data-filter="Pendiente" class="filter-btn bg-gray-200 px-4 py-2 rounded">Pendientes</button>
    <button data-filter="En Progreso" class="filter-btn bg-gray-200 px-4 py-2 rounded">En Progreso</button>
    <button data-filter="Completado" class="filter-btn bg-gray-200 px-4 py-2 rounded">Completadas</button>
  </div>

  <!-- TABLA AGRUPADA POR OBJETIVO -->
  <div id="grouped-table" class="mt-6 space-y-10"></div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbziwTWsFqJC7S-5_wh1V-5dD8Q-jFDR2oVAMBhL1MS6Z_J0zZRIlkestl2sTQSFEO70/exec";
const PASSWORD = "DIMAV2024";

const OBJECTIVE_NAMES = {
  1: "Informes de Confiabilidad",
  2: "Power BI",
  3: "Capacitaci√≥n (actualizada con SAP)",
  4: "Avi√≥nica"
};

let tasksData = [];
let currentFilter = "Todos";
let canEdit = false;

async function loadTasks() {
  const res = await fetch(API_URL);
  tasksData = await res.json();
}

async function saveTask(id, newStatus) {
  await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({id, status:newStatus})
  });
}

function getFilteredTasks() {
  if (currentFilter === "Todos") return tasksData;
  return tasksData.filter(t => t.status === currentFilter);
}

function renderObjectiveSummary() {
  const container = document.getElementById('objective-summary');
  container.innerHTML = '';
  const objetivos = [...new Set(tasksData.map(t=>t.objectiveId))];

  objetivos.forEach(obj => {
    const group = tasksData.filter(t=>t.objectiveId === obj);
    const total = group.length;
    const comp = group.filter(t=>t.status === 'Completado').length;
    const porcentaje = Math.round((comp/total)*100);

    container.innerHTML += `
      <li class="border rounded p-3 flex items-center gap-4">
        <span class="font-bold w-1/3">Objetivo ${obj}: ${OBJECTIVE_NAMES[obj]}</span>
        <div class="flex-1 bg-gray-200 rounded-full h-4">
          <div class="bg-green-500 h-4 rounded-full" style="width:${porcentaje}%"></div>
        </div>
        <span class="text-sm text-gray-600">${comp}/${total} completadas</span>
        <span class="font-bold text-green-700">${porcentaje}%</span>
      </li>
    `;
  });
}

function renderGroupedTable() {
  const container = document.getElementById('grouped-table');
  container.innerHTML = '';

  const tasks = getFilteredTasks();
  const objetivos = [...new Set(tasks.map(t=>t.objectiveId))];

  objetivos.forEach(obj => {
    const group = tasks.filter(t=>t.objectiveId === obj);
    const total = group.length;
    const comp = group.filter(t=>t.status === 'Completado').length;
    const porcentaje = Math.round((comp/total)*100);

    let html = `
      <div class="bg-white rounded shadow overflow-hidden">
        <div class="bg-gray-100 px-4 py-3 flex items-center gap-4">
          <h2 class="font-bold text-lg flex-1">üéØ Objetivo ${obj}: ${OBJECTIVE_NAMES[obj]}</h2>
          <div class="flex-1 bg-gray-300 h-3 rounded-full">
            <div class="bg-green-500 h-3 rounded-full" style="width:${porcentaje}%"></div>
          </div>
          <span class="ml-2 font-semibold text-green-700">${porcentaje}%</span>
        </div>
        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="py-2 px-4 border-b">ID</th>
              <th class="py-2 px-4 border-b">Actividad</th>
              <th class="py-2 px-4 border-b">Responsable</th>
              <th class="py-2 px-4 border-b">Plazo</th>
              <th class="py-2 px-4 border-b">Estado</th>
            </tr>
          </thead>
          <tbody>
    `;

    group.forEach(t => {
      html += `
        <tr class="border-b">
          <td class="py-2 px-4">${t.id}</td>
          <td class="py-2 px-4">${t.description}</td>
          <td class="py-2 px-4">${t.responsible}</td>
          <td class="py-2 px-4">${t.deadline}</td>
          <td class="py-2 px-4">
            <select data-id="${t.id}" class="border rounded p-1" ${!canEdit?'disabled':''}>
              <option ${t.status==='Pendiente'?'selected':''}>Pendiente</option>
              <option ${t.status==='En Progreso'?'selected':''}>En Progreso</option>
              <option ${t.status==='Completado'?'selected':''}>Completado</option>
            </select>
          </td>
        </tr>
      `;
    });

    html += `</tbody></table></div>`;
    container.innerHTML += html;
  });

  document.querySelectorAll('select[data-id]').forEach(sel=>{
    sel.addEventListener('change', async e=>{
      const id = e.target.dataset.id;
      const task = tasksData.find(x=>x.id == id);
      task.status = e.target.value;
      await saveTask(id, task.status);
      updateUI();
    });
  });
}

function updateCounters() {
  const c = {'Pendiente':0,'En Progreso':0,'Completado':0};
  tasksData.forEach(t=>c[t.status]++);
  document.getElementById('pending-count').textContent = c['Pendiente'];
  document.getElementById('progress-count').textContent = c['En Progreso'];
  document.getElementById('completed-count').textContent = c['Completado'];
}

function updateUI(){
  renderObjectiveSummary();
  renderGroupedTable();
  updateCounters();
}

document.addEventListener('DOMContentLoaded', async ()=>{
  document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      currentFilter = e.target.dataset.filter;
      document.querySelectorAll('.filter-btn').forEach(b=>{
        b.classList.remove('bg-blue-600','text-white');
        b.classList.add('bg-gray-200','text-gray-800');
      });
      e.target.classList.remove('bg-gray-200','text-gray-800');
      e.target.classList.add('bg-blue-600','text-white');
      updateUI();
    });
  });

  document.getElementById('btnLogin').addEventListener('click', ()=>{
    const clave = prompt("Ingrese la contrase√±a para habilitar edici√≥n:");
    if(clave === PASSWORD){
      canEdit = true;
      alert("‚úÖ Edici√≥n habilitada");
      updateUI();
    } else {
      alert("‚ùå Contrase√±a incorrecta");
    }
  });

  await loadTasks();
  updateUI();
});
</script>

</body>
</html>
