<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan de Acci√≥n - Confiabilidad</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="container mx-auto p-6 space-y-6">
  <h1 class="text-3xl font-bold text-center">Plan de Acci√≥n - Confiabilidad</h1>

  <div class="flex justify-between items-center">
    <div class="grid grid-cols-3 gap-4 text-center w-2/3">
      <div class="bg-yellow-100 p-4 rounded shadow">
        <p class="text-yellow-700 font-semibold">Pendientes</p>
        <p id="pending-count" class="text-3xl font-bold text-yellow-500">0</p>
      </div>
      <div class="bg-blue-100 p-4 rounded shadow">
        <p class="text-blue-700 font-semibold">En Progreso</p>
        <p id="progress-count" class="text-3xl font-bold text-blue-500">0</p>
      </div>
      <div class="bg-green-100 p-4 rounded shadow">
        <p class="text-green-700 font-semibold">Completadas</p>
        <p id="completed-count" class="text-3xl font-bold text-green-500">0</p>
      </div>
    </div>

    <button id="btnLogin" class="bg-gray-800 text-white px-4 py-2 rounded">üîê Iniciar sesi√≥n</button>
  </div>

  <!-- resumen por objetivo (barras grandes) -->
  <div id="objective-summary" class="bg-white p-4 rounded shadow"></div>

  <!-- filtros -->
  <div class="flex gap-3">
    <button data-filter="Todos" class="filter-btn bg-blue-600 text-white px-4 py-2 rounded">Todos</button>
    <button data-filter="Pendiente" class="filter-btn bg-gray-200 px-4 py-2 rounded">Pendientes</button>
    <button data-filter="En Progreso" class="filter-btn bg-gray-200 px-4 py-2 rounded">En Progreso</button>
    <button data-filter="Completado" class="filter-btn bg-gray-200 px-4 py-2 rounded">Completadas</button>
  </div>

  <!-- tabla agrupada -->
  <div id="grouped-table" class="mt-4 space-y-8"></div>
</div>

<script>
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbziwTWsFqJC7S-5_wh1V-5dD8Q-jFDR2oVAMBhL1MS6Z_J0zZRIlkestl2sTQSFEO70/exec"; // tu URL
const PASSWORD = "DIMAV2024";

const OBJECTIVE_NAMES = {
  "1": "Informes de Confiabilidad",
  "2": "Power BI",
  "3": "Capacitaci√≥n (actualizada con SAP)",
  "4": "Avi√≥nica"
};

/* estado */
let tasksData = [];
let currentFilter = "Todos";
let canEdit = false;

/* util */
function safeKey(x){ return (x===null||x===undefined)?'':String(x).trim(); }

/* fetch */
async function loadTasks(){
  const res = await fetch(API_URL);
  tasksData = await res.json();
  // normalizar por si faltan campos
  tasksData = tasksData.map(t => ({
    id: safeKey(t.id),
    objectiveId: safeKey(t.objectiveId) || 'Sin objetivo',
    description: safeKey(t.description),
    responsible: safeKey(t.responsible),
    deadline: safeKey(t.deadline),
    status: safeKey(t.status) || 'Pendiente'
  }));
}

/* save */
async function saveTask(id, newStatus){
  await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ id: String(id), status: newStatus })
  });
}

/* agrupaci√≥n ordenada: ensure objectives order 1..4 then others */
function getObjectivesOrdered(){
  const set = new Set(tasksData.map(t => t.objectiveId));
  // try to place 1..4 first
  const ordered = [];
  ['1','2','3','4'].forEach(k=>{ if(set.has(k)) { ordered.push(k); set.delete(k); } });
  // remaining
  set.forEach(x=>ordered.push(x));
  return ordered;
}

/* UI: resumen superior */
function renderObjectiveSummary(){
  const el = document.getElementById('objective-summary');
  el.innerHTML = '';
  const objetivos = getObjectivesOrdered();
  objetivos.forEach(obj => {
    const group = tasksData.filter(t => t.objectiveId === obj);
    const total = group.length;
    const comp = group.filter(t => t.status === 'Completado').length;
    const pct = total ? Math.round((comp/total)*100) : 0;
    const name = OBJECTIVE_NAMES[obj] || (obj === 'Sin objetivo' ? 'Sin objetivo' : `Objetivo ${obj}`);
    el.innerHTML += `
      <div class="border rounded p-3 mb-2 flex items-center gap-4">
        <div class="w-1/4 font-bold">${name}</div>
        <div class="flex-1 bg-gray-200 rounded-full h-4">
          <div class="bg-green-500 h-4 rounded-full" style="width:${pct}%"></div>
        </div>
        <div class="w-40 text-right">${comp}/${total} ‚Äî <strong>${pct}%</strong></div>
      </div>
    `;
  });
}

/* tabla agrupada por objetivo */
function renderGroupedTable(){
  const container = document.getElementById('grouped-table');
  container.innerHTML = '';
  const tasks = (currentFilter === 'Todos') ? tasksData : tasksData.filter(t => t.status === currentFilter);
  const objetivos = getObjectivesOrdered();

  objetivos.forEach(obj => {
    const group = tasks.filter(t => t.objectiveId === obj);
    if (group.length === 0) return;
    const total = group.length;
    const comp = group.filter(t=>t.status==='Completado').length;
    const pct = Math.round((comp/total)*100);
    const name = OBJECTIVE_NAMES[obj] || (obj === 'Sin objetivo' ? 'Sin objetivo' : `Objetivo ${obj}`);

    let html = `
      <div class="bg-white rounded shadow overflow-hidden">
        <div class="bg-gray-100 px-4 py-3 flex items-center gap-4">
          <h3 class="font-bold text-lg flex-1">üéØ ${name}</h3>
          <div class="flex-1 bg-gray-300 h-3 rounded-full">
            <div class="bg-green-500 h-3 rounded-full" style="width:${pct}%"></div>
          </div>
          <span class="ml-2 font-semibold text-green-700">${pct}%</span>
        </div>

        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="py-2 px-4 border-b">ID</th>
              <th class="py-2 px-4 border-b">Actividad</th>
              <th class="py-2 px-4 border-b">Responsable</th>
              <th class="py-2 px-4 border-b">Plazo</th>
              <th class="py-2 px-4 border-b">Estado</th>
            </tr>
          </thead>
          <tbody>
    `;

    group.forEach(t => {
      html += `
        <tr class="border-b">
          <td class="py-2 px-4">${t.id}</td>
          <td class="py-2 px-4">${t.description}</td>
          <td class="py-2 px-4">${t.responsible}</td>
          <td class="py-2 px-4">${t.deadline}</td>
          <td class="py-2 px-4">
            <select data-id="${t.id}" class="border rounded p-1" ${!canEdit ? 'disabled' : ''}>
              <option ${t.status==='Pendiente' ? 'selected' : ''}>Pendiente</option>
              <option ${t.status==='En Progreso' ? 'selected' : ''}>En Progreso</option>
              <option ${t.status==='Completado' ? 'selected' : ''}>Completado</option>
            </select>
          </td>
        </tr>
      `;
    });

    html += `</tbody></table></div>`;
    container.insertAdjacentHTML('beforeend', html);
  });

  // attach listeners
  document.querySelectorAll('select[data-id]').forEach(sel=>{
    sel.addEventListener('change', async e=>{
      const id = String(e.target.dataset.id);
      const newStatus = e.target.value;
      // update local copy
      const task = tasksData.find(x => String(x.id) === id);
      if (task) task.status = newStatus;
      // save server
      try {
        await saveTask(id, newStatus);
      } catch(err) {
        console.error('save error', err);
        alert('Error guardando en servidor');
      }
      // rerender
      await reloadAndRender();
    });
  });
}

/* contadores generales */
function updateCounters(){
  const c = {Pendiente:0,'En Progreso':0,Completado:0};
  tasksData.forEach(t=>{ c[t.status] = (c[t.status]||0)+1; });
  document.getElementById('pending-count').textContent = c['Pendiente'] || 0;
  document.getElementById('progress-count').textContent = c['En Progreso'] || 0;
  document.getElementById('completed-count').textContent = c['Completado'] || 0;
}

async function reloadAndRender(){
  await loadTasks();
  renderObjectiveSummary();
  renderGroupedTable();
  updateCounters();
}

/* handlers */
document.addEventListener('DOMContentLoaded', async ()=>{
  document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.addEventListener('click', e=>{
      currentFilter = e.target.dataset.filter;
      document.querySelectorAll('.filter-btn').forEach(b=>{
        b.classList.remove('bg-blue-600','text-white');
        b.classList.add('bg-gray-200','text-gray-800');
      });
      e.target.classList.remove('bg-gray-200','text-gray-800');
      e.target.classList.add('bg-blue-600','text-white');
      reloadAndRender();
    });
  });

  document.getElementById('btnLogin').addEventListener('click', ()=>{
    const clave = prompt('Ingrese la contrase√±a para habilitar edici√≥n:');
    if (clave === PASSWORD) {
      canEdit = true;
      alert('Edici√≥n habilitada');
      // Re-render to enable selects
      renderGroupedTable();
    } else {
      alert('Contrase√±a incorrecta');
    }
  });

  await reloadAndRender();
});
</script>
</body>
</html>
